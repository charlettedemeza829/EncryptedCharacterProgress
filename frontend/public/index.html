<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encrypted Character Progress • Zama FHEVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Required for Relayer SDK (WASM/Workers) -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />

  <style>
    :root {
      --bg-main: #f3f4f6;
      --bg-page: #e5e7eb;
      --bg-card: #ffffff;
      --bg-card-alt: #f9fafb;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --accent-strong: #1d4ed8;
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.06);
      --muted: #6b7280;
      --muted-soft: #9ca3af;
      --ink: #0f172a;
      --border: #e5e7eb;
      --border-soft: #e5e7eb;
      --border-strong: #cbd5e1;
      --radius-lg: 18px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.08);
      --shadow-card: 0 14px 30px rgba(15, 23, 42, 0.06);
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: var(--sans);
      background:
        radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.08), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(16, 185, 129, 0.06), transparent 60%),
        var(--bg-main);
      color: var(--ink);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 22px 16px 36px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* HEADER / HERO */

    .hero {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.5fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 880px) {
      .hero {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .hero-main {
      padding: 18px 18px 16px;
      border-radius: 20px;
      border: 1px solid var(--border-strong);
      background:
        linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(239, 246, 255, 0.9));
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .hero-main::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.12), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.08), transparent 60%);
      opacity: 0.5;
      pointer-events: none;
    }

    .hero-main-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: rgba(255, 255, 255, 0.8);
      font-size: 11px;
      color: var(--muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.25);
    }

    .hero-title {
      font-size: 23px;
      font-weight: 700;
      letter-spacing: 0.01em;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: baseline;
      color: var(--ink);
    }

    .hero-title span.label {
      font-size: 12px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .hero-title span.highlight {
      background: linear-gradient(120deg, #2563eb, #10b981);
      -webkit-background-clip: text;
      color: transparent;
    }

    .hero-sub {
      font-size: 13px;
      color: var(--muted);
      max-width: 520px;
    }

    .hero-meta-row {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .hero-meta-row strong {
      color: var(--ink);
      font-weight: 500;
    }

    .tag-soft {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: rgba(248, 250, 252, 0.9);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    .hero-connection {
      padding: 15px 16px 14px;
      border-radius: 18px;
      border: 1px solid var(--border-strong);
      background: var(--bg-card);
      box-shadow: var(--shadow-card);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .hero-connection-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .hero-connection-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .hero-connection-chiprow {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: var(--bg-card-alt);
      padding: 4px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-label {
      color: var(--muted-soft);
      font-weight: 500;
    }

    .chip-value {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink);
    }

    .chip-value.muted {
      color: var(--muted);
    }

    .mono {
      font-family: var(--mono);
    }

    /* BUTTONS */

    button {
      font-family: inherit;
      cursor: pointer;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: #111827;
      color: #f9fafb;
      padding: 7px 15px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.1s ease, transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.3);
    }

    .btn span.dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
    }

    .btn:hover:not([disabled]) {
      transform: translateY(-1px);
      background: #0f172a;
      border-color: var(--accent);
      box-shadow: 0 14px 24px rgba(15, 23, 42, 0.4);
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: #ffffff;
      color: #111827;
      border-color: var(--border-strong);
      box-shadow: none;
    }

    .btn-secondary:hover:not([disabled]) {
      background: #eff6ff;
      border-color: var(--accent);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.16);
    }

    .btn-ghost {
      background: transparent;
      color: #111827;
      border-style: dashed;
      box-shadow: none;
    }

    .btn-ghost:hover:not([disabled]) {
      background: #e5e7eb;
      border-style: solid;
    }

    .btn-small {
      padding: 5px 11px;
      font-size: 11px;
    }

    /* LAYOUT */

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .grid-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-strong);
      background: var(--bg-card);
      box-shadow: var(--shadow-card);
      padding: 13px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 9px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: -30%;
      opacity: 0.2;
      background:
        radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.16), transparent 60%),
        radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.12), transparent 60%);
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #111827;
    }

    .panel-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .panel-pill {
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--border-strong);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: rgba(249, 250, 251, 0.9);
    }

    .panel-pill.ok {
      border-color: rgba(22, 163, 74, 0.7);
      color: #166534;
      background: #dcfce7;
    }

    .panel-pill.bad {
      border-color: rgba(220, 38, 38, 0.7);
      color: #991b1b;
      background: #fee2e2;
    }

    .rows {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .row-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
    }

    .row-inline.stretch > * {
      flex: 1 1 0;
      min-width: 0;
    }

    /* INPUTS */

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 1 1 0;
      min-width: 0;
    }

    .field-label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .field-label span.title {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 500;
      color: #111827;
    }

    .field-label small {
      font-size: 10px;
      color: var(--muted-soft);
    }

    .input-shell {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 6px 9px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-shell-alt {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #ffffff;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-shell input,
    .input-shell-alt input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      color: #111827;
    }

    .input-shell input::placeholder,
    .input-shell-alt input::placeholder {
      color: var(--muted-soft);
      opacity: 0.9;
    }

    .input-suffix {
      font-size: 11px;
      color: var(--muted);
    }

    .input-prefix {
      font-size: 11px;
      color: var(--muted);
    }

    .field-helper {
      font-size: 10px;
      color: var(--muted);
    }

    .pill-mini {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      padding: 1px 6px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      background: #f9fafb;
    }

    /* STATS VIEW */

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 720px) {
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .stat-card {
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      padding: 7px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-card.primary {
      grid-column: span 3;
    }

    @media (max-width: 720px) {
      .stat-card.primary {
        grid-column: span 2;
      }
    }

    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      font-family: var(--mono);
      letter-spacing: 0.03em;
      color: #111827;
    }

    .stat-value.muted {
      color: var(--muted-soft);
      font-size: 14px;
    }

    .stat-handle {
      font-size: 10px;
      font-family: var(--mono);
      color: var(--muted);
      word-break: break-all;
    }

    .status-line {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-line strong {
      color: var(--ink);
      font-weight: 500;
    }

    .status-line span.bad {
      color: var(--danger);
    }

    .status-line span.good {
      color: #15803d;
    }

    .status-line span.weak {
      color: var(--muted);
    }

    .hint-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed var(--border-strong);
      color: var(--muted);
      background: #f9fafb;
    }

    .hint-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .note-https {
      font-size: 10px;
      color: var(--muted);
    }

    .note-https strong {
      color: #111827;
      font-weight: 500;
    }

    .note-https.ok strong {
      color: #15803d;
    }

    .note-https.warn strong {
      color: #b45309;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      font-size: 10px;
      color: var(--muted);
      background: #f9fafb;
    }

    .status-chip span.dot-ok {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .status-chip span.dot-bad {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.28);
    }

    .status-text-ok {
      color: #15803d;
    }

    .status-text-bad {
      color: #b91c1c;
    }

    .status-text-muted {
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HERO -->
    <header class="hero">
      <section class="hero-main">
        <div class="hero-main-inner">
          <div class="badge-pill">
            <span class="badge-dot"></span>
            <span>Private on-chain character growth</span>
          </div>
          <div class="hero-title">
            <span class="label">Zama FHEVM</span>
            <span>•</span>
            <span class="highlight">Encrypted Character Progress</span>
          </div>
          <p class="hero-sub">
            Level up your on-chain hero without leaking XP or skill values.
            All stats live encrypted on-chain; only you can decrypt them locally through the Relayer SDK.
          </p>
          <div class="hero-meta-row">
            <span class="tag-soft">XP &amp; skills: fully encrypted</span>
            <span>Game contract lives on <strong>Ethereum Sepolia</strong> using FHEVM.</span>
          </div>
        </div>
      </section>

      <section class="hero-connection">
        <div class="hero-connection-header">
          <div class="hero-connection-title">Wallet &amp; network</div>
          <button id="connectBtn" class="btn btn-small">
            <span class="dot"></span>
            <span id="connectLabel">Connect wallet</span>
          </button>
        </div>
        <div class="hero-connection-chiprow">
          <div class="chip">
            <span class="chip-label">Network</span>
            <span class="chip-value muted" id="netLabel">—</span>
          </div>
          <div class="chip">
            <span class="chip-label">You</span>
            <span class="chip-value muted" id="accountLabel">not connected</span>
          </div>
        </div>
        <div class="hero-connection-chiprow">
          <div class="chip">
            <span class="chip-label">Character contract</span>
            <span class="chip-value mono" id="contractLabel">—</span>
          </div>
          <div class="chip">
            <span class="chip-label">HTTPS decrypt</span>
            <span class="chip-value muted" id="httpsLabel">recommended</span>
          </div>
        </div>
      </section>
    </header>

    <!-- MAIN GRID -->
    <main class="grid-main">
      <!-- LEFT: CREATE / UPDATE -->
      <div class="stack">
        <!-- CHARACTER BASE INFO -->
        <section class="panel">
          <div class="panel-inner">
            <div class="panel-header">
              <div>
                <div class="panel-title">Character slot</div>
                <div class="panel-sub">
                  Choose which in-game character ID you want to use with this wallet.
                </div>
              </div>
              <div id="characterMetaTag" class="panel-pill">no character loaded</div>
            </div>
            <div class="rows">
              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">Character ID</span>
                    <small>integer &gt;= 1</small>
                  </label>
                  <div class="input-shell-alt">
                    <span class="input-prefix">#</span>
                    <input id="characterIdInput" type="number" min="1" value="1" />
                  </div>
                  <div class="field-helper">
                    Each wallet can host multiple encrypted characters (1, 2, 3, ...).
                  </div>
                </div>
                <div class="field" style="max-width: 150px;">
                  <label class="field-label">
                    <span class="title">Quick actions</span>
                  </label>
                  <div class="row-inline">
                    <button id="useChar1Btn" class="btn-ghost btn-small">Use #1</button>
                    <button id="useChar2Btn" class="btn-ghost btn-small">Use #2</button>
                  </div>
                  <div class="field-helper">
                    Only affects the ID used in forms below.
                  </div>
                </div>
              </div>

              <div class="status-line">
                <span id="characterMetaStatus">No on-chain check performed yet.</span>
                <button id="checkMetaBtn" class="btn-secondary btn-small">Check character on-chain</button>
              </div>
            </div>
          </div>
        </section>

        <!-- CREATE CHARACTER -->
        <section class="panel">
          <div class="panel-inner">
            <div class="panel-header">
              <div>
                <div class="panel-title">Create encrypted character</div>
                <div class="panel-sub">
                  Encrypt initial XP &amp; skills client-side and store them on-chain as opaque ciphertexts.
                </div>
              </div>
              <div class="panel-pill">step 1 • init</div>
            </div>

            <div class="rows">
              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">Initial XP</span>
                    <small>uint32 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="createXpInput" type="number" min="0" max="4294967295" placeholder="e.g. 100" />
                    <span class="input-suffix">xp</span>
                  </div>
                  <div class="field-helper">
                    XP is stored as <span class="mono">euint32</span> under FHE.
                  </div>
                </div>
              </div>

              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill I</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="createSkill1Input" type="number" min="0" max="65535" placeholder="e.g. 5" />
                    <span class="input-suffix">points</span>
                  </div>
                </div>
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill II</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="createSkill2Input" type="number" min="0" max="65535" placeholder="e.g. 3" />
                    <span class="input-suffix">points</span>
                  </div>
                </div>
              </div>

              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill III</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="createSkill3Input" type="number" min="0" max="65535" placeholder="e.g. 1" />
                    <span class="input-suffix">points</span>
                  </div>
                </div>
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill IV</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="createSkill4Input" type="number" min="0" max="65535" placeholder="e.g. 0" />
                    <span class="input-suffix">points</span>
                  </div>
                </div>
              </div>

              <div class="row-inline" style="justify-content: space-between; gap: 10px;">
                <button id="createCharacterBtn" class="btn btn-small">
                  <span class="dot"></span>
                  <span>Create encrypted character</span>
                </button>
                <span id="createStatus" class="field-helper"></span>
              </div>
            </div>
          </div>
        </section>

        <!-- UPDATE CHARACTER -->
        <section class="panel">
          <div class="panel-inner">
            <div class="panel-header">
              <div>
                <div class="panel-title">Apply encrypted progress</div>
                <div class="panel-sub">
                  Add XP and skill gains as encrypted deltas, without ever revealing raw values to the chain.
                </div>
              </div>
              <div class="panel-pill">step 2 • grow</div>
            </div>

            <div class="rows">
              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">XP delta</span>
                    <small>uint32 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="deltaXpInput" type="number" min="0" max="4294967295" placeholder="e.g. 50" />
                    <span class="input-suffix">xp</span>
                  </div>
                  <div class="field-helper">
                    Only non-negative deltas are supported (no XP refunds).
                  </div>
                </div>
              </div>

              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill I delta</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="deltaSkill1Input" type="number" min="0" max="65535" placeholder="e.g. 1" />
                    <span class="input-suffix">pts</span>
                  </div>
                </div>
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill II delta</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="deltaSkill2Input" type="number" min="0" max="65535" placeholder="0" />
                    <span class="input-suffix">pts</span>
                  </div>
                </div>
              </div>

              <div class="row-inline stretch">
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill III delta</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="deltaSkill3Input" type="number" min="0" max="65535" placeholder="0" />
                    <span class="input-suffix">pts</span>
                  </div>
                </div>
                <div class="field">
                  <label class="field-label">
                    <span class="title">Skill IV delta</span>
                    <small>uint16 • encrypted</small>
                  </label>
                  <div class="input-shell">
                    <input id="deltaSkill4Input" type="number" min="0" max="65535" placeholder="0" />
                    <span class="input-suffix">pts</span>
                  </div>
                </div>
              </div>

              <div class="row-inline" style="justify-content: space-between; gap: 10px;">
                <button id="updateCharacterBtn" class="btn-secondary btn-small">
                  <span>Encrypt &amp; apply progress</span>
                </button>
                <span id="updateStatus" class="field-helper"></span>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- RIGHT: DECRYPT VIEW -->
      <div class="stack">
        <section class="panel">
          <div class="panel-inner">
            <div class="panel-header">
              <div>
                <div class="panel-title">Decrypt my encrypted stats</div>
                <div class="panel-sub">
                  Use EIP-712 signing with the Relayer SDK to privately view XP &amp; skills for the selected character.
                </div>
              </div>
              <div id="decryptStatusTag" class="panel-pill">decrypt: HTTPS recommended</div>
            </div>

            <div class="rows">
              <div class="row-inline" style="justify-content: space-between; gap: 10px;">
                <div class="hint-pill">
                  <span class="dot"></span>
                  <span>Decryption keys live ephemerally in your browser only.</span>
                </div>
                <button id="decryptStatsBtn" class="btn-ghost btn-small">
                  Decrypt stats for this ID
                </button>
              </div>

              <div class="note-https" id="httpsNote">
                For the <strong>userDecrypt</strong> flow, serving the app over HTTPS is recommended so the WASM worker can run safely.
              </div>

              <div class="stats-grid">
                <div class="stat-card primary">
                  <div class="stat-label">XP (cleartext — local only)</div>
                  <div id="xpValue" class="stat-value muted">—</div>
                  <div id="xpHandle" class="stat-handle">xp handle: —</div>
                </div>

                <div class="stat-card">
                  <div class="stat-label">Skill I</div>
                  <div id="skill1Value" class="stat-value muted">—</div>
                  <div id="skill1Handle" class="stat-handle">handle: —</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Skill II</div>
                  <div id="skill2Value" class="stat-value muted">—</div>
                  <div id="skill2Handle" class="stat-handle">handle: —</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Skill III</div>
                  <div id="skill3Value" class="stat-value muted">—</div>
                  <div id="skill3Handle" class="stat-handle">handle: —</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Skill IV</div>
                  <div id="skill4Value" class="stat-value muted">—</div>
                  <div id="skill4Handle" class="stat-handle">handle: —</div>
                </div>
              </div>

              <div class="status-line">
                <span id="decryptStatusLine" class="status-text-muted">
                  Stats are decrypted locally via the Relayer SDK and never sent back on-chain.
                </span>
                <span id="characterExistenceTag" class="status-chip">
                  <span class="dot-bad"></span>
                  <span>No encrypted character yet</span>
                </span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Ethers + Relayer SDK -->
  <script type="module">
    import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
    import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    await initSDK();

    /* ---------- CONFIG ---------- */
    const CONTRACT_ADDRESS = "0xb039733e15Bb03a0b3CDA2B02c45700bD8E2A5EF";
    const CHAIN_ID_HEX = "0xaa36a7"; // Ethereum Sepolia

    const ORIGIN = window.location.origin;
    const HAS_LOCAL_PROXY = ORIGIN.includes("localhost:3443") || ORIGIN.includes("127.0.0.1:3443");
    const RELAYER_URL = HAS_LOCAL_PROXY ? `${ORIGIN}/relayer` : "https://relayer.testnet.zama.org";
    const GATEWAY_URL = HAS_LOCAL_PROXY ? `${ORIGIN}/gateway` : "https://gateway.testnet.zama.org";

    const IS_HTTPS = location.protocol === "https:";

    // ABI for EncryptedCharacterProgress
    const ABI = [
      { type: "function", name: "owner", stateMutability: "view", inputs: [], outputs: [{ type: "address" }] },
      { type: "function", name: "transferOwnership", stateMutability: "nonpayable", inputs: [{ name: "newOwner", type: "address" }], outputs: [] },

      {
        type: "function",
        name: "createCharacter",
        stateMutability: "nonpayable",
        inputs: [
          { name: "characterId", type: "uint256" },
          { name: "encXp", type: "bytes32" },
          { name: "encSkill1", type: "bytes32" },
          { name: "encSkill2", type: "bytes32" },
          { name: "encSkill3", type: "bytes32" },
          { name: "encSkill4", type: "bytes32" },
          { name: "proof", type: "bytes" }
        ],
        outputs: []
      },

      {
        type: "function",
        name: "updateCharacterProgress",
        stateMutability: "nonpayable",
        inputs: [
          { name: "characterId", type: "uint256" },
          { name: "encDeltaXp", type: "bytes32" },
          { name: "encDeltaSkill1", type: "bytes32" },
          { name: "encDeltaSkill2", type: "bytes32" },
          { name: "encDeltaSkill3", type: "bytes32" },
          { name: "encDeltaSkill4", type: "bytes32" },
          { name: "proof", type: "bytes" }
        ],
        outputs: []
      },

      {
        type: "function",
        name: "getCharacterMeta",
        stateMutability: "view",
        inputs: [
          { name: "player", type: "address" },
          { name: "characterId", type: "uint256" }
        ],
        outputs: [
          { type: "bool" }
        ]
      },

      {
        type: "function",
        name: "getMyCharacterHandles",
        stateMutability: "view",
        inputs: [
          { name: "characterId", type: "uint256" }
        ],
        outputs: [
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bool" }
        ]
      },

      {
        type: "function",
        name: "getCharacterXpHandleForOwner",
        stateMutability: "view",
        inputs: [
          { name: "player", type: "address" },
          { name: "characterId", type: "uint256" }
        ],
        outputs: [
          { type: "bytes32" },
          { type: "bool" }
        ]
      }
    ];

    /* ---------- DOM ---------- */
    const $ = (id) => document.getElementById(id);

    const connectBtn            = $("connectBtn");
    const connectLabelEl        = $("connectLabel");
    const netLabelEl            = $("netLabel");
    const accountLabelEl        = $("accountLabel");
    const contractLabelEl       = $("contractLabel");
    const httpsLabelEl          = $("httpsLabel");

    const characterIdInputEl    = $("characterIdInput");
    const useChar1Btn           = $("useChar1Btn");
    const useChar2Btn           = $("useChar2Btn");
    const characterMetaTagEl    = $("characterMetaTag");
    const characterMetaStatusEl = $("characterMetaStatus");
    const checkMetaBtn          = $("checkMetaBtn");

    const createXpInputEl       = $("createXpInput");
    const createSkill1InputEl   = $("createSkill1Input");
    const createSkill2InputEl   = $("createSkill2Input");
    const createSkill3InputEl   = $("createSkill3Input");
    const createSkill4InputEl   = $("createSkill4Input");
    const createCharacterBtn    = $("createCharacterBtn");
    const createStatusEl        = $("createStatus");

    const deltaXpInputEl        = $("deltaXpInput");
    const deltaSkill1InputEl    = $("deltaSkill1Input");
    const deltaSkill2InputEl    = $("deltaSkill2Input");
    const deltaSkill3InputEl    = $("deltaSkill3Input");
    const deltaSkill4InputEl    = $("deltaSkill4Input");
    const updateCharacterBtn    = $("updateCharacterBtn");
    const updateStatusEl        = $("updateStatus");

    const decryptStatsBtn       = $("decryptStatsBtn");
    const decryptStatusTagEl    = $("decryptStatusTag");
    const httpsNoteEl           = $("httpsNote");
    const decryptStatusLineEl   = $("decryptStatusLine");
    const characterExistenceTagEl = $("characterExistenceTag");

    const xpValueEl             = $("xpValue");
    const skill1ValueEl         = $("skill1Value");
    const skill2ValueEl         = $("skill2Value");
    const skill3ValueEl         = $("skill3Value");
    const skill4ValueEl         = $("skill4Value");

    const xpHandleEl            = $("xpHandle");
    const skill1HandleEl        = $("skill1Handle");
    const skill2HandleEl        = $("skill2Handle");
    const skill3HandleEl        = $("skill3Handle");
    const skill4HandleEl        = $("skill4Handle");

    contractLabelEl.textContent = shortAddress(CONTRACT_ADDRESS);

    /* ---------- STATE ---------- */
    const state = {
      provider: null,
      signer: null,
      contract: null,
      relayer: null,
      account: null
    };

    /* ---------- HELPERS: LOGGING & BIGINT ---------- */

    const safeStringify = (obj) =>
      JSON.stringify(obj, (k, v) => (typeof v === "bigint" ? v.toString() + "n" : v), 2);

    function appendLog(...parts) {
      const msg = parts
        .map((x) =>
          typeof x === "string"
            ? x
            : (() => {
                try {
                  return safeStringify(x);
                } catch {
                  return String(x);
                }
              })()
        )
        .join(" ");

      const tagStyle =
        "background:#111827;color:#bfdbfe;border-radius:999px;padding:2px 6px;font-size:10px;font-weight:700;font-family:system-ui, sans-serif;";
      const msgStyle =
        "color:#0f172a;font-family:ui-monospace,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;";

      console.log("%cFHE-CHAR%c " + msg, tagStyle, msgStyle);
    }

    function normalizeDecryptedValue(v) {
      if (v == null) return null;
      if (typeof v === "boolean") return v ? 1n : 0n;
      if (typeof v === "bigint" || typeof v === "number") return BigInt(v);
      if (typeof v === "string") return BigInt(v);
      return BigInt(v.toString());
    }

    function shortAddress(addr) {
      if (!addr) return "—";
      return addr.slice(0, 6) + "…" + addr.slice(-4);
    }

    function normalizeChainId(id) {
      if (!id) return "";
      const s = String(id);
      if (/^\d+$/.test(s)) {
        return "0x" + BigInt(s).toString(16);
      }
      return s.toLowerCase();
    }

    async function ensureSepolia() {
      if (!window.ethereum?.request) return false;
      let cur = normalizeChainId(
        await window.ethereum.request({ method: "eth_chainId" }).catch(() => null)
      );
      netLabelEl.textContent = cur || "unknown";
      if (cur === CHAIN_ID_HEX) return true;

      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: CHAIN_ID_HEX }]
        });
      } catch (e) {
        if (e && e.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [
              {
                chainId: CHAIN_ID_HEX,
                chainName: "Sepolia",
                nativeCurrency: { name: "Sepolia ETH", symbol: "SEP", decimals: 18 },
                rpcUrls: ["https://rpc.sepolia.org"],
                blockExplorerUrls: ["https://sepolia.etherscan.io"]
              }
            ]
          });
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: CHAIN_ID_HEX }]
          });
        } else {
          throw e;
        }
      }

      const after = normalizeChainId(
        await window.ethereum.request({ method: "eth_chainId" }).catch(() => null)
      );
      netLabelEl.textContent = after || "unknown";
      return after === CHAIN_ID_HEX;
    }

    function buildValuePicker(out, pairs) {
      let map = {};
      if (out && typeof out === "object") {
        // Layout 1: clearValues array + known order
        if (Array.isArray(out.clearValues) && pairs && pairs.length) {
          pairs.forEach((p, i) => {
            const h = String(p.handle || p).toLowerCase();
            map[h] = out.clearValues[i];
          });
        }

        // Layout 2: abiEncodedClearValues (concatenated 32-byte words)
        if (
          !Object.keys(map).length &&
          typeof out.abiEncodedClearValues === "string" &&
          pairs &&
          pairs.length
        ) {
          const raw = out.abiEncodedClearValues.startsWith("0x")
            ? out.abiEncodedClearValues.slice(2)
            : out.abiEncodedClearValues;
          const vals = [];
          for (let i = 0; i + 64 <= raw.length; i += 64) {
            const chunk = "0x" + raw.slice(i, i + 64);
            try {
              vals.push(BigInt(chunk));
            } catch {
              vals.push(0n);
            }
          }
          pairs.forEach((p, i) => {
            const h = String(p.handle || p).toLowerCase();
            map[h] = vals[i] ?? 0n;
          });
        }

        // Layout 3: simple map of handle -> value
        if (!Object.keys(map).length) {
          for (const [k, v] of Object.entries(out)) {
            map[k.toLowerCase()] = v;
          }
        }
      }

      return (handle) => {
        if (!handle) return null;
        const k = String(handle).toLowerCase();
        const v = map[k];
        if (v === undefined) return null;
        return normalizeDecryptedValue(v);
      };
    }

    async function userDecryptMany(relayer, signer, pairs) {
      const kp = await generateKeypair();
      const startTs = Math.floor(Date.now() / 1000).toString();
      const daysValid = "7";

      const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, daysValid);
      const sig = await signer.signTypedData(
        eip.domain,
        { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
        eip.message
      );

      const userAddr = await signer.getAddress();
      const out = await relayer.userDecrypt(
        pairs,
        kp.privateKey,
        kp.publicKey,
        sig.replace(/^0x/, ""),
        [CONTRACT_ADDRESS],
        userAddr,
        startTs,
        daysValid
      );
      appendLog("userDecrypt result:", out);
      return { out, pairs };
    }

    function updateHttpsUi() {
      if (IS_HTTPS) {
        httpsLabelEl.textContent = "secure ✓";
        decryptStatusTagEl.textContent = "decrypt: HTTPS ✓";
        decryptStatusTagEl.classList.remove("bad");
        decryptStatusTagEl.classList.add("ok");
        httpsNoteEl.classList.remove("warn");
        httpsNoteEl.classList.add("ok");
      } else {
        httpsLabelEl.textContent = "not secure";
        decryptStatusTagEl.textContent = "decrypt: open via HTTPS for full support";
        decryptStatusTagEl.classList.remove("ok");
        decryptStatusTagEl.classList.add("bad");
        httpsNoteEl.classList.remove("ok");
        httpsNoteEl.classList.add("warn");
      }
    }

    function setCharacterExistence(exists) {
      if (!characterExistenceTagEl) return;
      if (exists) {
        characterExistenceTagEl.innerHTML =
          '<span class="dot-ok"></span><span>Encrypted character exists</span>';
      } else {
        characterExistenceTagEl.innerHTML =
          '<span class="dot-bad"></span><span>No encrypted character yet</span>';
      }
    }

    function setCharacterMetaTag(exists) {
      const charId = Number(characterIdInputEl.value || "0");
      if (!exists) {
        characterMetaTagEl.textContent = `character #${charId || "?"} • not created`;
        characterMetaTagEl.classList.remove("ok");
        characterMetaTagEl.classList.add("bad");
      } else {
        characterMetaTagEl.textContent = `character #${charId} • encrypted stats live on-chain`;
        characterMetaTagEl.classList.remove("bad");
        characterMetaTagEl.classList.add("ok");
      }
    }

    function clearStatsView() {
      xpValueEl.textContent = "—";
      xpValueEl.classList.add("muted");
      skill1ValueEl.textContent = "—";
      skill1ValueEl.classList.add("muted");
      skill2ValueEl.textContent = "—";
      skill2ValueEl.classList.add("muted");
      skill3ValueEl.textContent = "—";
      skill3ValueEl.classList.add("muted");
      skill4ValueEl.textContent = "—";
      skill4ValueEl.classList.add("muted");

      xpHandleEl.textContent = "xp handle: —";
      skill1HandleEl.textContent = "handle: —";
      skill2HandleEl.textContent = "handle: —";
      skill3HandleEl.textContent = "handle: —";
      skill4HandleEl.textContent = "handle: —";

      decryptStatusLineEl.textContent =
        "Stats are decrypted locally via the Relayer SDK and never sent back on-chain.";
      decryptStatusLineEl.classList.remove("status-text-ok", "status-text-bad");
      decryptStatusLineEl.classList.add("status-text-muted");
    }

    /* ---------- CONNECTION ---------- */

    connectBtn.addEventListener("click", async () => {
      if (state.signer) {
        await disconnectWallet();
      } else {
        await connectWallet();
      }
    });

    async function connectWallet() {
      try {
        if (!window.ethereum?.request) {
          alert("Please install MetaMask or another EIP-1193 wallet.");
          return;
        }

        await ensureSepolia();

        const provider = new BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = await provider.getSigner();
        const account = await signer.getAddress();
        const contract = new Contract(CONTRACT_ADDRESS, ABI, signer);

        appendLog("Creating Relayer instance…");
        const relayer = await createInstance({
          ...SepoliaConfig,
          relayerUrl: RELAYER_URL,
          gatewayUrl: GATEWAY_URL,
          network: window.ethereum,
          debug: true
        });

        state.provider = provider;
        state.signer = signer;
        state.contract = contract;
        state.relayer = relayer;
        state.account = account;

        connectLabelEl.textContent = "Disconnect";
        connectBtn.classList.remove("btn-secondary");
        accountLabelEl.textContent = shortAddress(account);
        accountLabelEl.classList.remove("muted");
        netLabelEl.textContent = CHAIN_ID_HEX;

        appendLog("Relayer ready:", { relayerUrl: RELAYER_URL, gatewayUrl: GATEWAY_URL });

        updateHttpsUi();
        await refreshCharacterMeta();
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        appendLog("Connect failed:", msg);
        alert(msg);
      }
    }

    async function disconnectWallet() {
      state.provider = null;
      state.signer = null;
      state.contract = null;
      state.relayer = null;
      state.account = null;

      connectLabelEl.textContent = "Connect wallet";
      accountLabelEl.textContent = "not connected";
      accountLabelEl.classList.add("muted");
      setCharacterExistence(false);
      setCharacterMetaTag(false);
      clearStatsView();

      appendLog("Disconnected");
    }

    /* ---------- CHARACTER META ---------- */

    async function refreshCharacterMeta() {
      try {
        if (!state.contract || !state.account) {
          characterMetaStatusEl.textContent = "Connect wallet first.";
          setCharacterExistence(false);
          setCharacterMetaTag(false);
          return;
        }
        const charId = Number(characterIdInputEl.value || "0");
        if (!Number.isInteger(charId) || charId <= 0) {
          characterMetaStatusEl.textContent = "Character ID must be a positive integer.";
          setCharacterExistence(false);
          setCharacterMetaTag(false);
          return;
        }

        characterMetaStatusEl.textContent = "Checking on-chain…";
        const exists = await state.contract.getCharacterMeta(state.account, BigInt(charId));
        characterMetaStatusEl.textContent = exists
          ? `Encrypted character #${charId} exists for this wallet.`
          : `No encrypted character #${charId} found for this wallet.`;

        setCharacterExistence(exists);
        setCharacterMetaTag(exists);
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        appendLog("getCharacterMeta error:", msg);
        characterMetaStatusEl.textContent = msg;
        setCharacterExistence(false);
        setCharacterMetaTag(false);
      }
    }

    checkMetaBtn.addEventListener("click", () => {
      refreshCharacterMeta();
    });

    useChar1Btn.addEventListener("click", () => {
      characterIdInputEl.value = "1";
      refreshCharacterMeta();
      clearStatsView();
    });

    useChar2Btn.addEventListener("click", () => {
      characterIdInputEl.value = "2";
      refreshCharacterMeta();
      clearStatsView();
    });

    characterIdInputEl.addEventListener("change", () => {
      refreshCharacterMeta();
      clearStatsView();
    });

    /* ---------- CREATE CHARACTER ---------- */

    createCharacterBtn.addEventListener("click", async () => {
      try {
        if (!state.contract || !state.signer || !state.relayer || !state.account) {
          throw new Error("Connect your wallet first.");
        }

        const charId = Number(characterIdInputEl.value || "0");
        if (!Number.isInteger(charId) || charId <= 0) {
          throw new Error("Character ID must be a positive integer.");
        }

        const xpRaw = createXpInputEl.value.trim();
        const s1Raw = createSkill1InputEl.value.trim();
        const s2Raw = createSkill2InputEl.value.trim();
        const s3Raw = createSkill3InputEl.value.trim();
        const s4Raw = createSkill4InputEl.value.trim();

        const xp = Number(xpRaw || "0");
        const s1 = Number(s1Raw || "0");
        const s2 = Number(s2Raw || "0");
        const s3 = Number(s3Raw || "0");
        const s4 = Number(s4Raw || "0");

        if (!Number.isInteger(xp) || xp < 0 || xp > 4294967295) {
          throw new Error("Initial XP must be between 0 and 4,294,967,295.");
        }
        for (const [name, v] of [
          ["Skill I", s1],
          ["Skill II", s2],
          ["Skill III", s3],
          ["Skill IV", s4]
        ]) {
          if (!Number.isInteger(v) || v < 0 || v > 65535) {
            throw new Error(`${name} must be between 0 and 65,535.`);
          }
        }

        createStatusEl.textContent = "Encrypting initial stats…";

        const buf = state.relayer.createEncryptedInput(CONTRACT_ADDRESS, state.account);
        buf.add32(xp);
        buf.add16(s1);
        buf.add16(s2);
        buf.add16(s3);
        buf.add16(s4);

        const { handles, inputProof } = await buf.encrypt();
        appendLog("createCharacter encrypted handles:", handles);

        const tx = await state.contract.createCharacter(
          BigInt(charId),
          handles[0],
          handles[1],
          handles[2],
          handles[3],
          handles[4],
          inputProof
        );

        createStatusEl.textContent = "Transaction sent: " + tx.hash.slice(0, 10) + "…";
        appendLog("createCharacter tx:", tx.hash);

        await tx.wait();
        createStatusEl.textContent = "Encrypted character created ✓";
        appendLog("createCharacter confirmed");

        await refreshCharacterMeta();
        clearStatsView();
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        createStatusEl.textContent = msg;
        appendLog("createCharacter error:", msg);
        alert(msg);
      }
    });

    /* ---------- UPDATE CHARACTER PROGRESS ---------- */

    updateCharacterBtn.addEventListener("click", async () => {
      try {
        if (!state.contract || !state.signer || !state.relayer || !state.account) {
          throw new Error("Connect your wallet first.");
        }

        const charId = Number(characterIdInputEl.value || "0");
        if (!Number.isInteger(charId) || charId <= 0) {
          throw new Error("Character ID must be a positive integer.");
        }

        const xpRaw = deltaXpInputEl.value.trim();
        const d1Raw = deltaSkill1InputEl.value.trim();
        const d2Raw = deltaSkill2InputEl.value.trim();
        const d3Raw = deltaSkill3InputEl.value.trim();
        const d4Raw = deltaSkill4InputEl.value.trim();

        const dxp = Number(xpRaw || "0");
        const d1 = Number(d1Raw || "0");
        const d2 = Number(d2Raw || "0");
        const d3 = Number(d3Raw || "0");
        const d4 = Number(d4Raw || "0");

        if (!Number.isInteger(dxp) || dxp < 0 || dxp > 4294967295) {
          throw new Error("XP delta must be between 0 and 4,294,967,295.");
        }
        for (const [name, v] of [
          ["Skill I delta", d1],
          ["Skill II delta", d2],
          ["Skill III delta", d3],
          ["Skill IV delta", d4]
        ]) {
          if (!Number.isInteger(v) || v < 0 || v > 65535) {
            throw new Error(`${name} must be between 0 and 65,535.`);
          }
        }

        updateStatusEl.textContent = "Encrypting deltas…";

        const buf = state.relayer.createEncryptedInput(CONTRACT_ADDRESS, state.account);
        buf.add32(dxp);
        buf.add16(d1);
        buf.add16(d2);
        buf.add16(d3);
        buf.add16(d4);

        const { handles, inputProof } = await buf.encrypt();
        appendLog("updateCharacterProgress encrypted handles:", handles);

        const tx = await state.contract.updateCharacterProgress(
          BigInt(charId),
          handles[0],
          handles[1],
          handles[2],
          handles[3],
          handles[4],
          inputProof
        );

        updateStatusEl.textContent = "Transaction sent: " + tx.hash.slice(0, 10) + "…";
        appendLog("updateCharacterProgress tx:", tx.hash);

        await tx.wait();
        updateStatusEl.textContent = "Encrypted progress applied ✓";
        appendLog("updateCharacterProgress confirmed");

        await refreshCharacterMeta();
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        updateStatusEl.textContent = msg;
        appendLog("updateCharacterProgress error:", msg);
        alert(msg);
      }
    });

    /* ---------- DECRYPT STATS ---------- */

    decryptStatsBtn.addEventListener("click", async () => {
      try {
        if (!state.contract || !state.relayer || !state.signer || !state.account) {
          throw new Error("Connect your wallet first.");
        }
        if (!IS_HTTPS) {
          appendLog("userDecrypt requested on non-HTTPS origin.");
        }

        const charId = Number(characterIdInputEl.value || "0");
        if (!Number.isInteger(charId) || charId <= 0) {
          throw new Error("Character ID must be a positive integer.");
        }

        decryptStatusLineEl.textContent = "Fetching encrypted handles & decrypting via Relayer…";
        decryptStatusLineEl.classList.remove("status-text-bad", "status-text-ok");
        decryptStatusLineEl.classList.add("status-text-muted");

        const r = await state.contract.getMyCharacterHandles(BigInt(charId));
        const xpH = r?.[0];
        const s1H = r?.[1];
        const s2H = r?.[2];
        const s3H = r?.[3];
        const s4H = r?.[4];
        const exists = !!r?.[5];

        setCharacterExistence(exists);
        setCharacterMetaTag(exists);

        if (!exists || !xpH) {
          clearStatsView();
          decryptStatusLineEl.textContent =
            "No encrypted stats found for this character ID yet. Create the character first.";
          decryptStatusLineEl.classList.remove("status-text-ok");
          decryptStatusLineEl.classList.add("status-text-bad");
          return;
        }

        xpHandleEl.textContent = "xp handle: " + String(xpH);
        skill1HandleEl.textContent = "handle: " + String(s1H || "—");
        skill2HandleEl.textContent = "handle: " + String(s2H || "—");
        skill3HandleEl.textContent = "handle: " + String(s3H || "—");
        skill4HandleEl.textContent = "handle: " + String(s4H || "—");

        const pairs = [
          { handle: xpH, contractAddress: CONTRACT_ADDRESS },
          { handle: s1H, contractAddress: CONTRACT_ADDRESS },
          { handle: s2H, contractAddress: CONTRACT_ADDRESS },
          { handle: s3H, contractAddress: CONTRACT_ADDRESS },
          { handle: s4H, contractAddress: CONTRACT_ADDRESS }
        ];

        const { out, pairs: used } = await userDecryptMany(state.relayer, state.signer, pairs);
        const pick = buildValuePicker(out, used);

        const xpVal = pick(xpH);
        const s1Val = pick(s1H);
        const s2Val = pick(s2H);
        const s3Val = pick(s3H);
        const s4Val = pick(s4H);

        xpValueEl.textContent = xpVal != null ? xpVal.toString() : "n/a";
        xpValueEl.classList.remove("muted");

        skill1ValueEl.textContent = s1Val != null ? s1Val.toString() : "n/a";
        skill1ValueEl.classList.remove("muted");

        skill2ValueEl.textContent = s2Val != null ? s2Val.toString() : "n/a";
        skill2ValueEl.classList.remove("muted");

        skill3ValueEl.textContent = s3Val != null ? s3Val.toString() : "n/a";
        skill3ValueEl.classList.remove("muted");

        skill4ValueEl.textContent = s4Val != null ? s4Val.toString() : "n/a";
        skill4ValueEl.classList.remove("muted");

        decryptStatusLineEl.textContent =
          "Decryption successful. Numbers above were computed locally and never sent back to the chain.";
        decryptStatusLineEl.classList.remove("status-text-bad", "status-text-muted");
        decryptStatusLineEl.classList.add("status-text-ok");
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        appendLog("decryptStats error:", msg);
        decryptStatusLineEl.textContent = msg;
        decryptStatusLineEl.classList.remove("status-text-ok");
        decryptStatusLineEl.classList.add("status-text-bad");
        alert(msg);
      }
    });

    /* ---------- INIT ---------- */
    updateHttpsUi();
    clearStatsView();
    setCharacterExistence(false);
    setCharacterMetaTag(false);

    // Auto-connect if already authorized
    if (window.ethereum) {
      try {
        const accounts = await window.ethereum.request({ method: "eth_accounts" });
        if (accounts && accounts.length) {
          appendLog("Wallet already authorized, auto-connecting…");
          await connectWallet();
        }
      } catch (e) {
        appendLog("Auto-connect failed:", e?.message || e);
      }

      window.ethereum.on?.("accountsChanged", () => {
        location.reload();
      });
      window.ethereum.on?.("chainChanged", () => {
        location.reload();
      });
    }
  </script>
</body>
</html>
